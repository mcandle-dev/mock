# 개발 로그 - 2025-12-23

## 작업 개요
BLE 결제 시스템에 자동 고객 선택 기능 및 다중 고객 시뮬레이션 기능 추가

## 요구사항

### 1. 한 명일 때 자동 선택
- **기존**: Customer가 스캔하면 VPOS에 목록 표시 → 수동 선택 → 상세 조회
- **변경**: Customer가 1명만 스캔하면 VPOS는 **목록 없이 바로 상세 조회로 이동**

### 2. 두 명 시작 버튼 추가
- Customer 앱에 "2명 시작하기" 버튼 추가
  - 예시 1: 김준호 + 이영희
  - 예시 2: 이영희 + 박철수
- VPOS 결제대기 고객 목록에 2명이 출력됨

## 구현 내용

### 1. Customer App (`customer/src/App.jsx`)

#### 변경 사항
```javascript
// 기존: 단일 userId만 처리
const handleStartScan = (id = 'HD2023091234') => {
  socket.emit('customer-scan', id);
};

// 변경: 단일 또는 배열 처리
const handleStartScan = (userIds) => {
  socket.emit('customer-scan', userIds);
};
```

#### UI 변경
```javascript
// 기존: 3개의 단일 선택 버튼
<button onClick={() => handleStartScan('HD2023091234')}>김준호로 시작하기</button>
<button onClick={() => handleStartScan('HD2023091235')}>이영희로 시작하기</button>
<button onClick={() => handleStartScan('HD2023091236')}>박철수로 시작하기</button>

// 변경: 1명/2명 조합 버튼
<button onClick={() => handleStartScan('HD2023091234')}>1명으로 시작하기 (김준호)</button>
<button onClick={() => handleStartScan(['HD2023091234', 'HD2023091235'])}>2명 시작하기 (김준호 + 이영희)</button>
<button onClick={() => handleStartScan(['HD2023091235', 'HD2023091236'])}>2명 시작하기 (이영희 + 박철수)</button>
```

### 2. Server (`server/index.js`)

#### 핵심 로직 추가
```javascript
socket.on('customer-scan', (userIds) => {
    // 단일 userId(string)와 배열 모두 처리
    const idsArray = Array.isArray(userIds) ? userIds : [userIds];

    // 각 userId를 pendingCustomers에 추가
    idsArray.forEach(userId => {
        const user = users[userId] || users["HD2023091234"];
        if (!pendingCustomers.find(c => c.id === user.id)) {
            pendingCustomers.push({ ...user, socketId: socket.id });
        }
    });

    // 목록 업데이트 브로드캐스트
    io.emit('pending-customers-update', pendingCustomers);

    // 1명일 때 자동 선택
    if (pendingCustomers.length === 1) {
        const customer = pendingCustomers[0];
        const data = {
            user: customer,
            store: {
                name: "현대백화점 압구정점",
                location: "6F 스포츠관 나이키",
                staff: "한아름 (224456)"
            }
        };

        // Customer에게 연결 성공 알림
        io.to(customer.socketId).emit('ble-connection-success', data);

        // VPOS에게 자동 선택 이벤트 전송
        io.emit('vpos-auto-select', data);
    }
});
```

#### 이벤트 플로우
1. `customer-scan` 수신 → userId(s) 파싱
2. `pendingCustomers` 배열에 추가
3. `pending-customers-update` 브로드캐스트
4. **길이 === 1이면** `vpos-auto-select` 자동 발송

### 3. VPOS (`vpos/src/App.jsx`)

#### 새 이벤트 리스너 추가
```javascript
useEffect(() => {
    // 기존 이벤트...

    // 자동 선택 이벤트 추가
    socket.on('vpos-auto-select', (data) => {
        setCustomer(data.user);
        setStore(data.store);
        setScreen('MEMBERSHIP');  // SCANNED 건너뛰고 바로 MEMBERSHIP

        setTimeout(() => {
            setScreen('BENEFITS');
        }, 2000);
    });

    return () => {
        socket.off('vpos-auto-select');
        // 기존 cleanup...
    };
}, []);
```

#### 화면 전환 로직
- **1명일 때**: `SCANNED`(목록) 건너뛰고 → `MEMBERSHIP` → `BENEFITS`
- **2명 이상일 때**: 기존대로 `SCANNED`(목록 표시) → 수동 선택 → `MEMBERSHIP`

## 기술적 세부사항

### Socket.io 이벤트 구조

#### 신규 이벤트
| 이벤트명 | 방향 | 데이터 | 설명 |
|---------|------|--------|------|
| `customer-scan` | Customer → Server | `string \| string[]` | 단일 또는 복수 userId |
| `vpos-auto-select` | Server → VPOS | `{ user, store }` | 1명일 때 자동 선택 알림 |

#### 기존 이벤트 (수정 없음)
- `pending-customers-update`: 대기 고객 목록 브로드캐스트
- `ble-connection-success`: 연결 성공 알림 (Customer 및 VPOS)
- `vpos-select-customer`: VPOS에서 수동 선택

### 상태 관리
```javascript
// Server
let pendingCustomers = [];  // 각 customer는 { ...user, socketId }

// VPOS
const [pendingCustomers, setPendingCustomers] = useState([]);
const [screen, setScreen] = useState('MAIN');

// Customer
const [screen, setScreen] = useState('IDLE');
```

## 테스트 시나리오

### 시나리오 1: 1명 자동 선택
1. **VPOS**: "바코드 스캔 시뮬레이션" 클릭 → `SCANNED` 화면
2. **Customer**: "1명으로 시작하기 (김준호)" 클릭
3. **결과**:
   - VPOS가 `SCANNED` → `MEMBERSHIP` → `BENEFITS`로 자동 전환
   - 목록 화면 건너뜀 ✅

### 시나리오 2: 2명 수동 선택
1. **VPOS**: "바코드 스캔 시뮬레이션" 클릭 → `SCANNED` 화면
2. **Customer**: "2명 시작하기 (김준호 + 이영희)" 클릭
3. **결과**:
   - VPOS 결제대기 고객 목록에 2명 표시 ✅
   - 고객 선택 → `MEMBERSHIP` → `BENEFITS`

### 시나리오 3: 2명 중 한 명 선택
1. 시나리오 2 실행
2. **VPOS**: 목록에서 "이영희" 클릭
3. **결과**: 이영희 정보로 상세 화면 전환 ✅

## 변경된 파일 목록

```
D:\dev\aitest\
├── customer\src\App.jsx          (수정)
├── server\index.js                (수정)
├── vpos\src\App.jsx               (수정)
├── CLAUDE.md                      (신규 - 프로젝트 문서)
└── DEVLOG_2025-12-23.md          (신규 - 이 파일)
```

## 실행 방법

### 1. 서버 실행
```bash
cd server
node index.js
# Simulation Server running on http://localhost:4000
```

### 2. VPOS 실행
```bash
cd vpos
npm run dev
# Local: http://localhost:5173
```

### 3. Customer 실행
```bash
cd customer
npm run dev
# Local: http://localhost:5174
```

## 향후 개선 사항

1. **다중 소켓 ID 처리**: 현재는 마지막 socketId만 저장됨
   - 2명이 동시에 같은 Customer 앱에서 스캔하는 경우 모두 같은 socketId
   - 실제 환경에서는 각각 다른 디바이스이므로 문제없음

2. **자동 선택 취소**: 1명일 때 자동 선택되었지만 취소하고 싶은 경우
   - "이전" 버튼으로 `SCANNED`로 돌아가는 기능 추가 가능

3. **애니메이션 개선**: 자동 선택 시 "자동으로 연결되었습니다" 안내 메시지

## 성능 고려사항

- **메모리**: `pendingCustomers` 배열은 소켓 연결 해제 시 자동으로 정리됨
- **이벤트 빈도**: 3초 스캔 딜레이로 과도한 이벤트 발생 방지
- **브로드캐스트**: 모든 클라이언트에게 업데이트 전송 (현재 시뮬레이션 환경에서는 문제없음)

## 완료 체크리스트

- [x] Customer 앱 1명/2명 버튼 UI 구현
- [x] Server 자동 선택 로직 구현
- [x] VPOS 자동 선택 이벤트 수신
- [x] 1명 시나리오 테스트
- [x] 2명 시나리오 테스트
- [x] 개발 문서 작성

---

**작성자**: Claude Code
**작성일**: 2025-12-23
**소요 시간**: 약 30분
